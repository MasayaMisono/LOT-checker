<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>バーコード読取＆読み上げ（実験）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="スマホのカメラでバーコードを読み取り、その値を画面表示と音声で読み上げる実験用ツールです。"
  />

  <!-- Quagga2（バーコード読取ライブラリ） -->
  <script src="https://unpkg.com/@ericblade/quagga2@1.11.0/dist/quagga.min.js"></script>

  <style>
    :root {
      --bg: #020617;
      --card-bg: #0f172a;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.3);
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --border-soft: #1f2937;
      --radius-lg: 16px;
      --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.6);
      --ng: #f97316;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 12px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #020617, #000000 60%);
      color: var(--text-main);
    }

    .app {
      max-width: 520px;
      margin: 0 auto;
    }

    .app-header {
      padding: 8px 4px 4px;
    }

    .app-header h1 {
      font-size: 1.2rem;
      font-weight: 700;
      margin: 0 0 2px;
    }

    .app-subtitle {
      margin: 0;
      font-size: 0.8rem;
      color: var(--text-sub);
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 12px 10px;
      margin-top: 10px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(30, 64, 175, 0.3);
    }

    .card h2 {
      font-size: 0.95rem;
      margin: 0 0 8px;
      padding-bottom: 4px;
      border-bottom: 1px solid var(--border-soft);
    }

    /* カメラ表示エリア */
    #barcodeContainer {
      position: relative;
      width: 100%;
      aspect-ratio: 3 / 4;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
    }

    /* 認識エリアの目安枠（Quaggaが上に canvas を重ねる） */
    .scan-guide {
      position: absolute;
      top: 40%;
      left: 10%;
      width: 80%;
      height: 20%;
      border: 2px solid var(--accent);
      border-radius: 10px;
      pointer-events: none;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.4);
    }

    .scan-text {
      position: absolute;
      top: 8%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.75rem;
      color: var(--text-sub);
      background: rgba(15, 23, 42, 0.7);
      padding: 4px 8px;
      border-radius: 999px;
      pointer-events: none;
    }

    .action {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }

    .action button {
      flex: 1;
      padding: 10px 12px;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      color: #0b1120;
      background: var(--accent);
      cursor: pointer;
      box-shadow: 0 8px 16px rgba(22, 163, 74, 0.5);
      transition: transform 0.08s ease, box-shadow 0.08s ease,
        opacity 0.1s ease, background 0.1s ease;
    }

    .action button.secondary {
      background: #334155;
      color: #e5e7eb;
      box-shadow: 0 6px 12px rgba(15, 23, 42, 0.6);
    }

    .action button:active {
      transform: translateY(1px);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.5);
      opacity: 0.95;
    }

    .status {
      margin-top: 6px;
      font-size: 0.75rem;
      color: var(--text-sub);
      min-height: 1.2em;
    }

    .status-error {
      color: var(--ng);
    }

    .result-line {
      font-size: 0.95rem;
      margin: 4px 0;
    }

    .result-label {
      font-size: 0.8rem;
      color: var(--text-sub);
    }

    .code-value {
      font-size: 1.1rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      margin-top: 2px;
    }

    .note {
      font-size: 0.75rem;
      color: var(--text-sub);
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <h1>バーコード読取＆読み上げ</h1>
      <p class="app-subtitle">商品にかざしてコードを読み取り、音声で読み上げ</p>
    </header>

    <!-- カメラ -->
    <section class="card">
      <h2>カメラプレビュー</h2>
      <div id="barcodeContainer">
        <div class="scan-guide"></div>
        <div class="scan-text">バーコードを横向きでこの枠に合わせる</div>
      </div>
      <div class="action">
        <button id="startBtn">読み取り開始</button>
        <button id="stopBtn" class="secondary">停止</button>
      </div>
      <div id="status" class="status"></div>
      <p class="note">
        ※ スマホの背面カメラを使用します。明るい場所で、バーコードを横向きに枠内へ。<br>
        ※ 主に JAN/EAN 系など一般的なバーコードに対応しています。
      </p>
    </section>

    <!-- 結果 -->
    <section class="card">
      <h2>読み取り結果</h2>
      <div class="result-line">
        <div class="result-label">コード</div>
        <div id="codeValue" class="code-value">未読み取り</div>
      </div>
      <p class="note">
        読み取りに成功すると、ここにコードが表示され、同時に音声で読み上げます。<br>
        ロット番号として扱う場合は、この値をそのまま控える／他のフォームに貼り付けて使えます。
      </p>
    </section>
  </div>

  <script>
    const statusEl = document.getElementById("status");
    const codeEl = document.getElementById("codeValue");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const container = document.getElementById("barcodeContainer");

    let isRunning = false;
    let lastCode = "";
    let lastSpokenAt = 0;

    function setStatus(msg, isError = false) {
      statusEl.textContent = msg;
      if (isError) {
        statusEl.classList.add("status-error");
      } else {
        statusEl.classList.remove("status-error");
      }
    }

    function speak(text) {
      if (!("speechSynthesis" in window)) {
        setStatus("音声読み上げに対応していないブラウザです。", true);
        return;
      }
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "ja-JP";
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }

    function startScanner() {
      if (isRunning) return;

      // Quagga 初期化
      Quagga.init(
        {
          inputStream: {
            type: "LiveStream",
            target: container,
            constraints: {
              facingMode: "environment"
            },
            area: { // 認識エリアの割合（中央寄せ）
              top: "30%",
              right: "10%",
              left: "10%",
              bottom: "30%"
            }
          },
          decoder: {
            readers: [
              "ean_reader",
              "ean_8_reader",
              "code_128_reader",
              "code_39_reader",
              "upc_reader",
              "upc_e_reader"
            ]
          },
          locate: true
        },
        function(err) {
          if (err) {
            console.error(err);
            setStatus("初期化エラー: " + err.message, true);
            return;
          }
          Quagga.start();
          isRunning = true;
          setStatus("読み取り中… バーコードを枠内に合わせてください。");
        }
      );

      // 認識成功時
      Quagga.onDetected(onDetected);
    }

    function stopScanner() {
      if (!isRunning) return;
      Quagga.offDetected(onDetected);
      Quagga.stop();
      isRunning = false;
      setStatus("停止しました。再開するには『読み取り開始』を押してください。");
    }

    function onDetected(result) {
      if (!result || !result.codeResult || !result.codeResult.code) return;

      const code = result.codeResult.code;
      const now = Date.now();

      // 同じコードを連続で何回も読み上げないよう、少し間引く
      if (code === lastCode && now - lastSpokenAt < 1500) {
        return;
      }

      lastCode = code;
      lastSpokenAt = now;

      codeEl.textContent = code;
      setStatus("読み取り成功：" + code);

      // 読み上げ：数字をそのまま読んでくれる
      speak(`バーコード、${code}`);
    }

    startBtn.addEventListener("click", () => {
      startScanner();
    });

    stopBtn.addEventListener("click", () => {
      stopScanner();
    });

    // ページ離脱時にカメラ停止
    window.addEventListener("beforeunload", () => {
      if (isRunning) {
        stopScanner();
      }
    });
  </script>
</body>
</html>
